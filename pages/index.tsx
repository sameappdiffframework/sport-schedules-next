import Stack from '@mui/material/Stack'
import { DateTime } from 'luxon'
import type { GetStaticProps, NextPage } from 'next'
import Head from 'next/head'
import React from 'react'
import Header from '../comps/header'
import SingleDaySchedule from '../comps/single-day-schedule'
import type { Game, GamesByDate } from '../lib/model'

const BUILD_TIME_FORMAT_OPTIONS: Intl.DateTimeFormatOptions = {
    weekday: 'short', day: 'numeric', month: 'short',
    hour: 'numeric', minute: 'numeric', timeZoneName: 'short'
}

interface PageProps {
    schedule: GamesByDate
}

const Home: NextPage<PageProps> = ({ schedule }) => {
    const buildTime = DateTime.fromISO(schedule._meta.buildDate).setZone('America/Chicago');
    return (
        <>
            <Head>
                <title>Create Next App</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="initial-scale=1, width=device-width" />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <Header />
            <main>
                <Stack spacing={2}>
                    {Object.entries(schedule.gamesByDate)
                        .map(([date, games], i) => (<SingleDaySchedule games={games} date={DateTime.fromISO(date)} key={i} />))
                    }
                </Stack>
            </main>
            <footer>
                <p><small>The data powering this site was gathered at {buildTime.toLocaleString(BUILD_TIME_FORMAT_OPTIONS)}.</small></p>
            </footer>
        </>
    )
}

export const getStaticProps: GetStaticProps<PageProps> = async (context) => {
    function filterGamesToTheNextWeek(gamesByDate: Record<string, Game[]>): Record<string, Game[]> {
        const startOfDay = DateTime.now().setZone('America/New_York').startOf('day');
        const entries = Object.entries(gamesByDate)
            .filter(([date]) => {
                const gametime = DateTime.fromISO(date).setZone('America/New_York');
                const sevenDaysFromNow = startOfDay
                    .setZone('America/New_York')
                    .plus({ days: 7 })
                    .startOf('day')
                return startOfDay <= gametime && gametime <= sevenDaysFromNow
            })
        return Object.fromEntries(entries)
    }
    const schedule = await fetch('https://sport-schedules.netlify.app/basketball/gamesByDate.json')
        .then(response => response.json() as Promise<GamesByDate>)
        .then(schedule => Object.assign({}, schedule, { gamesByDate: filterGamesToTheNextWeek(schedule.gamesByDate) }));
    return {
        props: { schedule: schedule }
    }
}

export default Home
