import { DateTime } from 'luxon'
import type { NextPage } from 'next'
import { GetStaticProps } from 'next'
import Head from 'next/head'
import React from 'react'
import SingleDaySchedule from '../comps/single-day-schedule'
import type { GamesByDate } from '../lib/model'

const Home: NextPage<{ schedule: GamesByDate, nowDateString: string }> = ({ schedule, nowDateString }) => {
    const startOfDay = DateTime.fromISO(nowDateString).setZone('America/New_York').startOf('day');
    const buildTime = DateTime.fromISO(schedule._meta.buildDate).setZone('America/New_York');
    return (
        <>
            <Head>
                <title>Create Next App</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <main>
                <h2>Upcoming games</h2>
                {Object.entries(schedule.gamesByDate)
                    .filter(([date, games]) => {
                        const gametime = DateTime.fromISO(date).setZone('America/New_York');
                        const sevenDaysFromNow = startOfDay
                            .setZone('America/New_York')
                            .plus({ days: 7 })
                            .startOf('day')
                        return startOfDay <= gametime && gametime <= sevenDaysFromNow
                    })
                    .map(([date, games], i) => (<SingleDaySchedule games={games} date={new Date(date)} key={i} />))
                }
            </main>
            <footer>
                <p><small>The data powering this site was gathered at {buildTime.toISO()}</small></p>
            </footer>
        </>
    )
}

export const getStaticProps: GetStaticProps = async (context) => {
    const schedule = await fetch('https://sport-schedules.netlify.app/basketball/gamesByDate.json')
        .then(response => response.json() as Promise<GamesByDate>)
    return {
        props: { schedule: schedule, nowDateString: DateTime.now().toISO() }
    }
}

export default Home
